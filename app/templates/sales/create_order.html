{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">New Sales Order</h1>
</div>

<form method="POST" id="salesForm">
    <div class="row mb-4">
        <div class="col-md-6">
            <label class="form-label">Select Customer</label>
            <select class="form-select" name="customer_id" required>
                <option value="">-- Choose Customer --</option>
                {% for customer in customers %}
                <option value="{{ customer.id }}">{{ customer.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6">
            <label class="form-label">Discount (â‚¹)</label>
            <input type="number" step="0.01" class="form-control" name="discount" value="0">
        </div>
    </div>

    <h4>Order Items</h4>
    <div class="table-responsive">
        <table class="table table-bordered" id="itemsTable">
            <thead>
                <tr>
                    <th width="40%">Product</th>
                    <th>Available</th>
                    <th>Quantity</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <select class="form-select" name="product_id[]" required onchange="updatePrice(this)">
                            <option value="">-- Select Product --</option>
                            {% for product in products %}
                            <option value="{{ product.id }}" data-price="{{ product.selling_price }}"
                                data-stock="{{ product.stock_quantity }}">{{ product.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><input type="text" class="form-control-plaintext stock-display" readonly></td>
                    <td><input type="number" class="form-control" name="quantity[]" min="1" value="1"
                            onchange="calculateRow(this)" required></td>
                    <td><input type="number" step="0.01" class="form-control" name="price[]" readonly></td>
                    <td><input type="text" class="form-control" name="total[]" readonly></td>
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)"><i
                                class="fas fa-trash"></i></button></td>
                </tr>
            </tbody>
        </table>
    </div>

    <button type="button" class="btn btn-secondary btn-sm mb-3" onclick="addRow()">
        <i class="fas fa-plus"></i> Add Item
    </button>

    <div class="row justify-content-end">
        <div class="col-md-4">
            <button type="submit" class="btn btn-success w-100 btn-lg">Generate Invoice</button>
        </div>
    </div>
</form>

<script>
    function addRow() {
        var table = document.getElementById("itemsTable").getElementsByTagName('tbody')[0];
        var newRow = table.rows[0].cloneNode(true);

        // Clear values
        var inputs = newRow.getElementsByTagName('input');
        for (var i = 0; i < inputs.length; i++) {
            inputs[i].value = (inputs[i].name === 'quantity[]') ? '1' : '';
        }
        newRow.getElementsByTagName('select')[0].value = '';

        table.appendChild(newRow);
    }

    function removeRow(btn) {
        var row = btn.parentNode.parentNode;
        if (document.getElementById("itemsTable").getElementsByTagName('tbody')[0].rows.length > 1) {
            row.parentNode.removeChild(row);
        }
    }

    function updatePrice(select) {
        var price = select.options[select.selectedIndex].getAttribute('data-price');
        var stock = select.options[select.selectedIndex].getAttribute('data-stock');

        var row = select.parentNode.parentNode;
        var priceInput = row.querySelector('input[name="price[]"]');
        var stockDisplay = row.querySelector('.stock-display');

        if (price) priceInput.value = price;
        if (stock) stockDisplay.value = stock;

        calculateRow(select);
    }

    function calculateRow(element) {
        var row = element.parentNode.parentNode;
        var qty = row.querySelector('input[name="quantity[]"]').value;
        var price = row.querySelector('input[name="price[]"]').value;
        var totalField = row.querySelector('input[name="total[]"]');

        if (qty && price) {
            totalField.value = (parseFloat(qty) * parseFloat(price)).toFixed(2);
        }
    }
</script>
{% endblock %}